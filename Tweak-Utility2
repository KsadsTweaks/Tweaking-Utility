Add-Type -AssemblyName System.Windows.Forms

# Function to apply registry tweaks
function Apply-Tweak {
    param(
        [string]$Path,
        [string]$Name,
        [string]$Type,
        [string]$Value,
        [string]$Description
    )
    try {
        $fullPath = Join-Path $Path $Name
        if (-not (Test-Path -Path $Path -PathType Container)) {
            Write-Warning "Registry key '$Path' does not exist. Creating..."
            New-Item -Path $Path -ItemType Directory -Force | Out-Null
        }
        Set-ItemProperty -Path $Path -Name $Name -Value $Value -Type $Type -ErrorAction Stop
        Write-Host "Applied: $($fullPath) = $Value  ($Description)" -ForegroundColor Green
        return $true
    }
    catch {
        Write-Error "Failed to apply $($fullPath): $($_.Exception.Message)"
        return $false
    }
}

# Create a system restore point
function Create-RestorePoint {
    param (
        [string]$description = "Registry Tweaks Restore Point"
    )
    try {
        $restorePoint = New-Object -ComObject "SystemRestore"
        $restorePoint.CreateRestorePoint($description, 0, 100)
        return $true
    }
    catch {
        Write-Error "Failed to create restore point: $_"
        return $false
    }
}

# Prompt user to create a restore point
$restorePrompt = [System.Windows.Forms.MessageBox]::Show("Would you like to create a system restore point before applying tweaks?", "Create Restore Point", [System.Windows.Forms.MessageBoxButtons]::YesNo, [System.Windows.Forms.MessageBoxIcon]::Question)

$restoreCreated = $false
if ($restorePrompt -eq [System.Windows.Forms.DialogResult]::Yes) {
    if (Create-RestorePoint) {
        [System.Windows.Forms.MessageBox]::Show("Restore point created successfully.", "Restore Point", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Information)
        $restoreCreated = $true
    } else {
        [System.Windows.Forms.MessageBox]::Show("Failed to create a restore point. The feature may not be available on this system.", "Error", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Error)
    }
}

# List of Tweaks with Descriptions
$tweaks = @(
    @{ Category = "Privacy"; Description = "Disable Telemetry"; Path = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection"; Name = "AllowTelemetry"; Type = "DWORD"; Value = 0; },
    @{ Category = "Privacy"; Description = "Disable Diagnostic Tracking Services"; Path = "HKLM:\SYSTEM\CurrentControlSet\Services\DiagTrack"; Name = "Start"; Type = "DWORD"; Value = 4; },
    @{ Category = "Privacy"; Description = "Disable Advertising ID"; Path = "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\AdvertisingInfo"; Name = "Enabled"; Type = "DWORD"; Value = 0; },
    @{ Category = "Cortana"; Description = "Disable Cortana"; Path = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Search"; Name = "AllowCortana"; Type = "DWORD"; Value = 0; },
    @{ Category = "Cortana"; Description = "Disable Bing Search in Start Menu"; Path = "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Search"; Name = "BingSearchEnabled"; Type = "DWORD"; Value = 0; },
    @{ Category = "System"; Description = "Disable Feedback Requests"; Path = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\DataCollection"; Name = "DoNotShowFeedbackNotifications"; Type = "DWORD"; Value = 1; },
    @{ Category = "UI"; Description = "Remove Lock Screen"; Path = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization"; Name = "NoLockScreen"; Type = "DWORD"; Value = 1; },
    @{ Category = "UI"; Description = "Disable Transparency Effects"; Path = "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize"; Name = "EnableTransparency"; Type = "DWORD"; Value = 0; },
    @{ Category = "Edge"; Description = "Disable Edge Preloading"; Path = "HKCU:\SOFTWARE\Microsoft\Edge\Main"; Name = "PreloadHttpsURL"; Type = "DWORD"; Value = 0; },
    @{ Category = "Performance"; Description = "Disable Unnecessary Visual Effects"; Path = "HKCU:\Control Panel\Desktop"; Name = "VisualFXSetting"; Type = "REG_SZ"; Value = "2"; },
    @{ Category = "Network"; Description = "Disable Network Discovery"; Path = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System"; Name = "EnableNetworkDiscovery"; Type = "DWORD"; Value = 0; },

    # Network Tweaks
    @{ Category = "Network"; Description = "Disable Teredo"; Command = "netsh interface teredo set state disabled" },
    @{ Category = "Network"; Description = "Disable 6to4"; Command = "netsh interface 6to4 set state disabled" },
    @{ Category = "Network"; Description = "Reset Winsock"; Command = "netsh winsock reset" },
    @{ Category = "Network"; Description = "Disable ISATAP"; Command = "netsh int isatap set state disable" },
    @{ Category = "Network"; Description = "Enable Task Offload"; Command = "netsh int ip set global taskoffload=enabled" },
    @{ Category = "Network"; Description = "Set Neighbor Cache Limit"; Command = "netsh int ip set global neighborcachelimit=4096" },
    @{ Category = "Network"; Description = "Disable TCP Timestamps"; Command = "netsh int tcp set global timestamps=disabled" },
    @{ Category = "Network"; Description = "Disable TCP Heuristics"; Command = "netsh int tcp set heuristics disabled" },
    @{ Category = "Network"; Description = "Set TCP Auto-tuning to Normal"; Command = "netsh int tcp set global autotuninglevel=normal" },
    @{ Category = "Network"; Description = "Set TCP Congestion Provider to Ctcp"; Command = "netsh int tcp set global congestionprovider=ctcp" },
    @{ Category = "Network"; Description = "Enable TCP RSS"; Command = "netsh int tcp set global rss=enabled" },
    @{ Category = "Network"; Description = "Disable TCP RSC"; Command = "netsh int tcp set global rsc=disabled" },
    @{ Category = "Network"; Description = "Enable DCA"; Command = "netsh int tcp set global dca=enabled" },
    @{ Category = "Network"; Description = "Enable NetDMA"; Command = "netsh int tcp set global netdma=enabled" },
    @{ Category = "Network"; Description = "Disable Nonsack RTT Resiliency"; Command = "netsh int tcp set global nonsackrttresiliency=disabled" },
    @{ Category = "Network"; Description = "Disable MPP"; Command = "netsh int tcp set security mpp=disabled" },
    @{ Category = "Network"; Description = "Disable Security Profiles"; Command = "netsh int tcp set security profiles=disabled" }
)

# Save current registry values before applying changes for rollback
$previousValues = @{}
foreach ($tweak in $tweaks) {
    if ($tweak.PSObject.Properties.Match("Path")) {
        $currentValue = Get-ItemProperty -Path $tweak.Path -Name $tweak.Name -ErrorAction SilentlyContinue
        if ($currentValue) {
            $previousValues[$tweak.Description] = $currentValue
        }
    }
}

# Create the Form
$form = New-Object System.Windows.Forms.Form
$form.Text = "Windows Tweaks"
$form.Size = New-Object System.Drawing.Size(500, 500)
$form.StartPosition = 'CenterScreen'
$form.FormBorderStyle = 'FixedDialog'
$form.MaximizeBox = $false
$form.MinimizeBox = $false

$panel = New-Object System.Windows.Forms.Panel
$panel.Dock = 'Fill'
$panel.AutoScroll = $true
$form.Controls.Add($panel)

# Add Tweaks to the Form
$flowLayoutPanel = New-Object System.Windows.Forms.FlowLayoutPanel
$flowLayoutPanel.Dock = 'Fill'
$flowLayoutPanel.AutoScroll = $true
$flowLayoutPanel.FlowDirection = 'TopDown'
$flowLayoutPanel.WrapContents = $true
$panel.Controls.Add($flowLayoutPanel)

foreach ($tweak in $tweaks) {
    $checkbox = New-Object System.Windows.Forms.CheckBox
    $checkbox.Text = "$($tweak.Category): $($tweak.Description)"
    $checkbox.AutoSize = $true
    $checkbox.Tag = $tweak
    $flowLayoutPanel.Controls.Add($checkbox)
}

# Apply Button
$applyButton = New-Object System.Windows.Forms.Button
$applyButton.Text = "Apply Selected Tweaks"
$applyButton.Dock = 'Bottom'
$applyButton.Height = 30
$form.Controls.Add($applyButton)

# Rollback Button
$rollbackButton = New-Object System.Windows.Forms.Button
$rollbackButton.Text = "Rollback Changes"
$rollbackButton.Dock = 'Bottom'
$rollbackButton.Height = 30
$form.Controls.Add($rollbackButton)

# Apply Button Click Event
$applyButton.Add_Click({
    $results = @()
    foreach ($control in $flowLayoutPanel.Controls | Where-Object {$_.GetType().Name -eq "CheckBox"}) {
        if ($control.Checked) {
            $tweak = $control.Tag
            if ($tweak.PSObject.Properties.Match("Command")) {
                $result = Invoke-Expression $tweak.Command
                Write-Host "Applied: $($tweak.Description)" -ForegroundColor Green
            } else {
                $result = Apply-Tweak -Path $tweak.Path -Name $tweak.Name -Type $tweak.Type -Value $tweak.Value -Description $tweak.Description
            }
            $results += [PSCustomObject]@{
                Description = $tweak.Description
                Success = $result
            }
        }
    }
    $successCount = ($results | Where-Object {$_.Success}).Count
    $failureCount = ($results | Where-Object {-not $_.Success}).Count

    $message = "Tweaks applied. Success: $successCount, Failures: $failureCount"
    if ($failureCount -gt 0) {
        $failureDetails = ($results | Where-Object {-not $_.Success} | ForEach-Object {$_.Description}) -join "`n"
        $message += "`nFailures Details: $failureDetails"
    }
    [System.Windows.Forms.MessageBox]::Show($message, "Results", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Information)

    # Don't close the form
})

# Rollback Button Click Event
$rollbackButton.Add_Click({
    foreach ($tweak in $previousValues.Keys) {
        $value = $previousValues[$tweak]
        Set-ItemProperty -Path $tweak.Path -Name $tweak.Name -Value $value -Type $value.GetType().Name -ErrorAction SilentlyContinue
    }
    [System.Windows.Forms.MessageBox]::Show("Changes rolled back to previous settings.", "Rollback", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Information)
})

$form.ShowDialog()
